#!/bin/bash
set -eux -o pipefail

# There are currently four modes: password, from, to, from-to.  To test the
# password part we'd have to pipe into /dev/tty or something (or provide an
# option to change the password device).

boxbin=$(readlink -f box.debug)
export LD_LIBRARY_PATH=$(readlink -f libsodium/lib)

abox() {
    BOX_HOME=a valgrind -q "$boxbin" "$@"
}

bbox() {
    BOX_HOME=b valgrind -q "$boxbin" "$@"
}

trap 'rm -rf testing' EXIT
rm -rf testing
mkdir testing
cd testing

aid=$(abox new-identity alice)
bid=$(bbox new-identity bob)
abox add-contact $bid
bbox add-contact $aid

echo hello | abox seal -from alice | bbox open
echo hello | abox seal -to bob | bbox open
echo hello | abox seal -from alice -to bob | bbox open

