#!/bin/bash -ue

gcc -g -Wall -Werror -Inacl/include/amd64 main.c nacl/lib/amd64/libnacl.a nacl/lib/amd64/randombytes.o

PATH=".:$PATH"

success() {
  echo -e "\xe2\x9c\x93 $1" >&2
}

failure() {
  echo -e "\xe2\x9c\x97 $1" >&2
  exit 1
}

box-generate-key >password

head -c 10000 /dev/urandom >sample
valgrind -q box password <sample >boxed

if diff sample boxed >/dev/null
then
  failure "Sample and boxed don't differ"
else
  success "Sample and boxed differ"
fi

valgrind -q unbox password <boxed >unboxed
if diff sample unboxed >/dev/null
then
  success "Sample and unboxed are equal"
else
  failure "Sample and boxed aren't equal"
fi

